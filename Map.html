<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
		<script src="https://d3js.org/d3.v3.min.js"></script>
		<link type="text/css" rel="stylesheet" href="Map.css">
</head>

	<body onload="load()">
		<div id = "dropDown">
			<select id="dataset" onchange="changeTopic(this.options[this.selectedIndex].innerHTML); changeDropdown(this.options[this.selectedIndex].innerHTML)"></select>
			<select id = "attribute" onChange="changeAttr(this.options[this.selectedIndex].innerHTML)"></select>
		</div>
		<div id="map"></div>
		<div id="tooltip"></div>
		<script>
		var w = window.innerWidth/2;
		var h = window.innerHeight/2;
		var base_color = d3.scale.category20();
		var variableName, clicking = 0;
		var attributesJSON;
		var list = document.getElementById("attribute");

		// Make drop down list of topics
		var topicsJSON=d3.json('JSON/List/topics.json',function(json){
				topicsJSON=json;
				d3.select("#dataset").selectAll("option")
									.data(topicsJSON)
									.enter()
									.append("option")
									.attr("id", function(d,i) {
										return ("option" + i)
									})
									.text(function(d) {
										if (d.name!="Unknown"){
											return d.name;
										}else{
											return d.id;
										}
									})
									.attr("title",function(d){
										return d.name;
									});
			});

		// Make drop down list of attributes
			d3.json('JSON/List/Economics.json',function(json){
				d3.select("#attribute").selectAll("option")
									.data(json)
									.enter()
									.append("option")
									.attr("id", function(d,i) {
										return ("option" + i)
									})
									.text(function(d) {
										if (d.name!="Unknown"){
											return d.name;
										}else{
											return d.id;
										}
									})
									.attr("title",function(d){
										return d.name;
									});
			});

		function load(){
			d3.json('JSON/Economics.json', function(error, data){
				if(error) console.log("error fetching data");
				variableName_0 = "JOBS_DENSI"
				var attrValue = []; // store all the values of selected attribute.
				for (var i = 0; i < data.features.length; i++){
					attrValue[i] = data.features[i].properties[variableName_0];
				}
				var attrMax = d3.max(attrValue);
				var attrMin = d3.min(attrValue);
				// Draw London Map
				var svg = d3.select("body").append("svg")
					.attr("id", "map")
					.attr("width", w)
					.attr("height",h);
				var group = svg.selectAll("g")
					.data(data.features)
					.enter()
					.append("g");
				var projection = d3.geo.mercator()
					.scale([40000])
					.center(d3.geo.centroid(data));
				var path = d3.geo.path().projection(projection);
				var tooltipDiv = document.getElementById('tooltip');
				var areas = group.append("path")
					.attr("d",path)
					.attr("class", "area")
					.style("fill", function(d){
						return base_color(d.properties[variableName_0])
					});
			});
    	}

    	// Change Attribute List based on the Selected Topic
    	function changeDropdown(topic){
   
    		removeDropDown();

    		var topic = d3.select("#dataset").node().value;
    		attributesJSON = d3.json('JSON/List/' + topic + '.json',function(json){
				attributesJSON = json;
				d3.select("#attribute").selectAll("option")
									.data(attributesJSON)
									.enter()
									.append("option")
									.attr("id", function(d,i) {
										return ("option" + i)
									})
									.text(function(d) {
										if (d.name!="Unknown"){
											return d.name;
										}else{
											return d.id;
										}
									})
									.attr("title",function(d){
										return d.name;
									});
			});
    	}

    	// Change Topic
    	function changeTopic(topic, sel){
    		d3.selectAll("#map").transition().remove();
    		var topic  = d3.select("#dataset").node().value;
    		var dataset = topic;
   			var sel = d3.select("#attribute").node().value;
    		drawMap(sel);
    	}
    	
		// Change Attribute
		function changeAttr(sel){
			d3.selectAll("#map").transition().remove();
			drawMap(sel);
		}

		// Make a Map
		function drawMap(sel){

			var dataset  = d3.select("#dataset").node().value;
			d3.json('JSON/' + dataset + '.json', function(error, data){
				if(error) console.log("error fetching data");

				// Get the selected value of the dropdown list
				var sel = d3.select("#attribute").node().value;
					variableName = attributeName(sel);
					
				console.log(sel + " " + variableName)

				var attrValue = []; // store all the values of selected attribute.
				for (var i = 0; i < data.features.length; i++){
					attrValue[i] = data.features[i].properties[variableName];
				}
				var attrMax = d3.max(attrValue);
				var attrMin = d3.min(attrValue);
				var colorScale = d3.scale.linear()
					.range(["#2c7bb6","#d7191c"])
					.domain([attrMin, attrMax])
				// Draw London Map
				var svg = d3.select("body").append("svg")
					.attr("id", "map")
					.attr("width", w)
					.attr("height",h);
				var group = svg.selectAll("g")
					.data(data.features)
					.enter()
					.append("g");
				var projection = d3.geo.mercator()
					.scale([40000])
					.center(d3.geo.centroid(data));
				var path = d3.geo.path().projection(projection);
				var tooltipDiv = document.getElementById('tooltip');
				var areas = group.append("path")
					.attr("d",path)
					.attr("class", "area")
					.style("fill", function(d){
						return colorScale(d.properties[variableName])
					})
					.style("fill-opacity", 0.8)
					.style("stroke", "rgba(5, 4, 4, 0.6)")
					.on("click", function(d){
						var currentDistrict = this;
						if (clicking == 0){
							d3.select(this).style("fill-opacity", 1) // Highlight selected area
								.style("stroke", "rgba(5, 4, 4, 1)");
 								tooltipDiv.style.display = "block"; // Show tooltip
 							if(dataset == "Economics"){
 								tooltipDiv.innerHTML = 
								"District Name: " + d.properties.PROV3NAME + "<br/>" + 
								sel + ": " + d.properties[variableName] + "<br/>"
 							}else{
 								tooltipDiv.innerHTML = 
								"COA Code: " + d.properties.COA_Code + "<br/>" + 
								sel + ": " + d.properties[variableName] + "<br/>"
 							}
							clicking = 1;
						}else{
							d3.selectAll("path").style("fill-opacity",0.8)
							.style("stroke", "rgba(5, 4, 4, 0.6)");
							tooltipDiv.style.display = "none"; // hide tooltip
							clicking = 0;
						}
					});
			});
		}

		// Get District Name
		function districtName(d){
			return d && d.properties? d.properties.PROV3NAME:null;
		}

		// Get variable name from Attribute list
		function attributeName(val){
			attributesJSON.forEach(function(d){
				if (d.name == val){
					return variableName = d.abs;
				}
			})
			return variableName
		}

		// Remove Options from Dropdown List
        function removeDropDown(){
            if (list.options.length > 0){
                for (var i = list.options.length - 1; i >=0 ;i-- ){
                    list.remove(i);
                }
            }
        }
			
		</script>
	</body>
</html>